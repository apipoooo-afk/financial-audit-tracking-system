<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • ค้นหาข้อมูล Manual | ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์</title>
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --line:#dde5f2; --text:#24364c; --muted:#6a7f9a;
      --brand:#1e5aaa; --brand2:#2f7de1; --shadow:0 10px 28px rgba(20,40,80,.08); --r:18px;
      --ok:#1f7a3b; --bad:#b13b3b; --warn:#8a5a00; --info:#0b5aa6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans";background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
      padding:14px 18px;display:flex;align-items:center;gap:12px
    }
    .title{display:flex;flex-direction:column;line-height:1.1}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .spacer{flex:1}
    .badge{border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa;padding:8px 12px;border-radius:14px;font-weight:900;white-space:nowrap}

    .wrap{max-width:1100px;margin:18px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{
      grid-column:span 12;background:var(--card);border:1px solid var(--line);
      border-radius:var(--r);box-shadow:var(--shadow);padding:14px;min-width:0
    }
    @media(min-width:980px){
      .col6{grid-column:span 6}
    }
    h2{margin:0 0 8px;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}

    label{display:block;font-size:12px;color:var(--muted);font-weight:900;margin:6px 0 4px}
    input,select{
      width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 10px;background:#fff;
      color:var(--text);outline:none;font-size:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:220px}

    .btn{
      width:100%;border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px 12px;
      cursor:pointer;font-weight:900;color:var(--text);text-align:center
    }
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
    .btn.warn{border-color:#ffe7b8;background:#fff7e6;color:var(--warn)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa}
    .pill.info{border-color:#cfe2ff;background:#eef6ff;color:var(--info)}

    .noteBox{border:1px dashed #cfe2ff;background:#f6fbff;border-radius:14px;padding:10px 12px}
    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;font-weight:900}
    .okBox{border:1px solid #c8f2d6;background:#effaf3;color:var(--ok)}
    .badBox{border:1px solid #ffd2d2;background:#fff0f0;color:var(--bad)}
    .warnBox{border:1px solid #ffe7b8;background:#fff7e6;color:var(--warn)}
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>Admin • ค้นหาข้อมูล Manual</h1>
    <small>2.2.1–2.2.4 ค้นหาตามปีงบ / หน่วยรับตรวจ / ที่ตั้ง / คำค้น</small>
  </div>
  <div class="spacer"></div>
  <div class="badge" id="userBadge">กำลังตรวจสอบสิทธิ…</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Search by FY -->
    <div class="card col6">
      <h2>2.2.1 ค้นหาตามปีงบประมาณ</h2>
      <div class="muted">เลือกปีงบประมาณ 2560–2580 แล้วกดค้นหา</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <label>ปีงบประมาณ</label>
          <select id="fyOnly">
            <option value="">— เลือกปีงบประมาณ —</option>
          </select>
        </div>
        <div>
          <label>งวด (ตัวเลือกเสริม)</label>
          <select id="periodOnly">
            <option value="">ทั้งหมด</option>
            <option value="YEAR">รายปี</option>
            <option value="Q1">ไตรมาส 1</option>
            <option value="Q2">ไตรมาส 2</option>
            <option value="Q3">ไตรมาส 3</option>
            <option value="Q4">ไตรมาส 4</option>
            <option value="M01">ม.ค.</option><option value="M02">ก.พ.</option><option value="M03">มี.ค.</option>
            <option value="M04">เม.ย.</option><option value="M05">พ.ค.</option><option value="M06">มิ.ย.</option>
            <option value="M07">ก.ค.</option><option value="M08">ส.ค.</option><option value="M09">ก.ย.</option>
            <option value="M10">ต.ค.</option><option value="M11">พ.ย.</option><option value="M12">ธ.ค.</option>
          </select>
        </div>
      </div>
      <div style="height:10px"></div>
      <button class="btn primary" id="btnFySearch">ค้นหาตามปีงบ</button>
      <div class="msg warnBox" id="fyWarn"></div>
    </div>

    <!-- Search by Entity -->
    <div class="card col6">
      <h2>2.2.2 ค้นหาตามชื่อหน่วยรับตรวจ</h2>
      <div class="muted">เลือกประเภท/พิมพ์ชื่อ/ค้นหาจากคำ</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <label>ประเภท อปท.</label>
          <select id="etype">
            <option value="">ทั้งหมด</option>
            <option value="อบจ">อบจ</option>
            <option value="ทม">ทม</option>
            <option value="ทน">ทน</option>
            <option value="ทต">ทต</option>
            <option value="อบต">อบต</option>
          </select>
        </div>
        <div>
          <label>คำค้นชื่อหน่วย (พิมพ์)</label>
          <input id="ename" placeholder="เช่น เทศบาลเมืองศรีสะเกษ" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>ปีงบ (ตัวเลือกเสริม)</label>
          <select id="fyEntity">
            <option value="">ทั้งหมด</option>
          </select>
        </div>
        <div>
          <label>สถานะ FA (2.1.7) (ตัวเลือกเสริม)</label>
          <select id="faStatus">
            <option value="">ทั้งหมด</option>
            <option value="ยุติการติดตามผล">ยุติการติดตามผล</option>
            <option value="อยู่ระหว่างติดตามผลการตรวจสอบ">อยู่ระหว่างติดตามผลการตรวจสอบ</option>
            <option value="ออกรายงานการตรวจแล้ว">ออกรายงานการตรวจแล้ว</option>
            <option value="อยู่ระหว่างจัดพิมพ์รายงาน">อยู่ระหว่างจัดพิมพ์รายงาน</option>
            <option value="อยู่ระหว่างสอบทานของ ผตจ.">อยู่ระหว่างสอบทานของ ผตจ.</option>
            <option value="อยู่ระหว่างสอบทาน ผอก.">อยู่ระหว่างสอบทาน ผอก.</option>
            <option value="อยู่ระหว่างตรวจสอบ">อยู่ระหว่างตรวจสอบ</option>
            <option value="ยังไม่ตรวจ">ยังไม่ตรวจ</option>
            <option value="ไม่ทราบสถานะ">ไม่ทราบสถานะ</option>
          </select>
        </div>
      </div>
      <div style="height:10px"></div>
      <button class="btn primary" id="btnEntitySearch">ค้นหาตามหน่วย</button>
      <div class="msg warnBox" id="entWarn"></div>
    </div>

    <!-- Search by Location -->
    <div class="card col6">
      <h2>2.2.3 ค้นหาตามที่ตั้ง (จังหวัด/อำเภอ/ตำบล)</h2>
      <div class="muted">พิมพ์อย่างน้อย 1 ช่อง แล้วค้นหา</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <label>จังหวัด</label>
          <input id="prov" placeholder="เช่น ศรีสะเกษ" />
        </div>
        <div>
          <label>อำเภอ</label>
          <input id="dist" placeholder="เช่น เมืองศรีสะเกษ" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>ตำบล</label>
          <input id="subd" placeholder="เช่น โพธิ์" />
        </div>
        <div>
          <label>ปีงบ (ตัวเลือกเสริม)</label>
          <select id="fyLoc">
            <option value="">ทั้งหมด</option>
          </select>
        </div>
      </div>
      <div style="height:10px"></div>
      <button class="btn primary" id="btnLocSearch">ค้นหาตามที่ตั้ง</button>
      <div class="msg warnBox" id="locWarn"></div>
    </div>

    <!-- Search by Keyword -->
    <div class="card col6">
      <h2>2.2.4 ค้นหาตามคำ</h2>
      <div class="muted">ค้นหาจากคำทั่วไป (ชื่อหน่วย/ผู้ตรวจ/หมายเหตุ/ปัญหา/ข้อเสนอแนะ ฯลฯ)</div>
      <div class="hr"></div>
      <div class="row">
        <div>
          <label>คำค้น (Keyword)</label>
          <input id="kw" placeholder="เช่น เงินขาดบัญชี / ปิดงบ / อปท.8.10 / ปัญหาเรื่องคน" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>ปีงบ (ตัวเลือกเสริม)</label>
          <select id="fyKw">
            <option value="">ทั้งหมด</option>
          </select>
        </div>
        <div>
          <label>ประเภท อปท. (ตัวเลือกเสริม)</label>
          <select id="etypeKw">
            <option value="">ทั้งหมด</option>
            <option value="อบจ">อบจ</option>
            <option value="ทม">ทม</option>
            <option value="ทน">ทน</option>
            <option value="ทต">ทต</option>
            <option value="อบต">อบต</option>
          </select>
        </div>
      </div>
      <div style="height:10px"></div>
      <button class="btn primary" id="btnKwSearch">ค้นหาตามคำ</button>
      <div class="msg warnBox" id="kwWarn"></div>
    </div>

    <!-- Footer nav -->
    <div class="card">
      <div class="row">
        <div class="noteBox" style="flex:2">
          <div class="muted">
            เคล็ดลับ: ถ้าต้องการ “กว้างแต่แม่น” ให้ใช้ค้นหาตามคำ + ปีงบ (เสริม)  
            ถ้าต้องการ “เป๊ะตามพื้นที่” ให้ใช้ค้นหาตามที่ตั้ง
          </div>
          <div style="margin-top:8px">
            <span class="pill info" id="stat">พร้อมค้นหา</span>
          </div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;gap:10px">
          <button class="btn" id="goAdminHome">กลับหน้า Admin</button>
          <button class="btn" id="goTable">ไปตาราง Manual (Excel)</button>
          <button class="btn" id="goDataHub">ไป Data Hub</button>
          <button class="btn" id="goCashboard">ไป Cashboard</button>
          <button class="btn" id="goHome">กลับหน้าหลัก</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================
   Guard: ADMIN only
   ========================= */
const SESSION_KEY = "fa_session_v1";
const session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
if(!session){ location.href="login.html"; }
const role = (session.role||"USER").toUpperCase();
document.getElementById("userBadge").textContent =
  "ผู้ใช้: " + (session.fullname || session.username) + " • บทบาท: " + role;

if(role !== "ADMIN"){
  alert("หน้านี้สำหรับ ADMIN เท่านั้น");
  location.href="index.html";
}

/* =========================
   Keys
   ========================= */
const MANUAL_KEY = "fa_manual_records_v1";
const SEARCH_KEY = "fa_admin_manual_search_v1"; // ส่งเงื่อนไขไปหน้า results

/* =========================
   Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
function show(box, text){
  const el = $(box);
  el.textContent = text;
  el.style.display="block";
  setTimeout(()=>el.style.display="none", 2400);
}
function getData(){ return JSON.parse(localStorage.getItem(MANUAL_KEY) || "[]"); }
function countActive(){
  const all = getData();
  return all.filter(x=>!x?.deleted).length;
}
function setSearch(payload){
  localStorage.setItem(SEARCH_KEY, JSON.stringify(payload));
}
function goResults(){
  location.href="admin-manual-results.html";
}
function buildFyOptions(){
  const start=2560, end=2580;
  const fyOnly = $("fyOnly");
  const fyEntity = $("fyEntity");
  const fyLoc = $("fyLoc");
  const fyKw = $("fyKw");
  for(let y=start;y<=end;y++){
    const o=document.createElement("option");
    o.value=String(y); o.textContent=String(y);
    fyOnly.appendChild(o);

    const o2=o.cloneNode(true);
    const o3=o.cloneNode(true);
    const o4=o.cloneNode(true);
    fyEntity.appendChild(o2);
    fyLoc.appendChild(o3);
    fyKw.appendChild(o4);
  }
}

/* =========================
   Actions: search modes
   ========================= */
$("btnFySearch").addEventListener("click", ()=>{
  const fy = $("fyOnly").value;
  const period = $("periodOnly").value;
  if(!fy){
    show("fyWarn","กรุณาเลือกปีงบประมาณ");
    return;
  }
  setSearch({
    mode:"FY",
    fy,
    period: period || "",
    created_at: Date.now(),
    by: (session.fullname || session.username)
  });
  goResults();
});

$("btnEntitySearch").addEventListener("click", ()=>{
  const etype = $("etype").value;
  const ename = $("ename").value.trim();
  const fy = $("fyEntity").value;
  const faStatus = $("faStatus").value;

  if(!ename && !etype){
    show("entWarn","กรุณาพิมพ์ชื่อหน่วย หรือเลือกประเภท อปท. อย่างน้อย 1 อย่าง");
    return;
  }

  setSearch({
    mode:"ENTITY",
    entity_type: etype || "",
    entity_name_q: ename || "",
    fy: fy || "",
    fa_status: faStatus || "",
    created_at: Date.now(),
    by: (session.fullname || session.username)
  });
  goResults();
});

$("btnLocSearch").addEventListener("click", ()=>{
  const prov = $("prov").value.trim();
  const dist = $("dist").value.trim();
  const subd = $("subd").value.trim();
  const fy = $("fyLoc").value;

  if(!prov && !dist && !subd){
    show("locWarn","กรุณากรอกอย่างน้อย 1 ช่อง: จังหวัด / อำเภอ / ตำบล");
    return;
  }

  setSearch({
    mode:"LOCATION",
    province_q: prov || "",
    district_q: dist || "",
    subdistrict_q: subd || "",
    fy: fy || "",
    created_at: Date.now(),
    by: (session.fullname || session.username)
  });
  goResults();
});

$("btnKwSearch").addEventListener("click", ()=>{
  const kw = $("kw").value.trim();
  const fy = $("fyKw").value;
  const etype = $("etypeKw").value;

  if(!kw){
    show("kwWarn","กรุณาพิมพ์คำค้น");
    return;
  }

  setSearch({
    mode:"KEYWORD",
    keyword: kw,
    fy: fy || "",
    entity_type: etype || "",
    created_at: Date.now(),
    by: (session.fullname || session.username)
  });
  goResults();
});

/* =========================
   Navigation
   ========================= */
$("goAdminHome").addEventListener("click", ()=>location.href="admin.html");
$("goTable").addEventListener("click", ()=>location.href="admin-manual-table.html");
$("goDataHub").addEventListener("click", ()=>location.href="data-hub.html");
$("goCashboard").addEventListener("click", ()=>location.href="cashboard.html");
$("goHome").addEventListener("click", ()=>location.href="index.html");

/* =========================
   Init
   ========================= */
buildFyOptions();
$("stat").textContent = `ข้อมูล Manual ปัจจุบัน: ${countActive()} รายการ`;
</script>
</body>
</html>
