<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ค้นหา Manual Data (Admin) • 2.2 ค้นหาข้อมูล • ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์</title>

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --line:#dde5f2; --text:#24364c; --muted:#6a7f9a;
      --brand:#1e5aaa; --brand2:#2f7de1;
      --shadow:0 10px 28px rgba(20,40,80,.08);
      --r:18px;
      --ok:#1f7a3b; --bad:#b13b3b; --warn:#8a5a00; --info:#0b5aa6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans";background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
      padding:14px 18px;display:flex;align-items:center;gap:12px
    }
    .title{display:flex;flex-direction:column;line-height:1.05}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .spacer{flex:1}
    .badge{border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa;padding:8px 12px;border-radius:14px;font-weight:900}

    .wrap{max-width:1200px;margin:18px auto;padding:0 18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;min-width:0}
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:12px 0 8px;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}

    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-size:14px;outline:none
    }
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:180px}

    .btn{
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:10px 12px; cursor:pointer; font-weight:900; color:var(--text);
      white-space:nowrap
    }
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;font-weight:900}
    .okBox{border:1px solid #c8f2d6;background:#effaf3;color:var(--ok)}
    .badBox{border:1px solid #ffd2d2;background:#fff0f0;color:var(--bad)}
    .warnBox{border:1px solid #ffe7b8;background:#fff7e6;color:var(--warn)}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa}
    .pill.info{border-color:#cfe2ff;background:#eef6ff;color:var(--info)}
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>ค้นหา Manual Data (Admin) — 2.2</h1>
    <small>ค้นหาตามปีงบฯ / หน่วยรับตรวจ / พื้นที่ / คำค้น (keyword) แล้วไปหน้า 2.3 ผลการค้นหา</small>
  </div>
  <div class="spacer"></div>
  <div class="badge" id="userBadge">กำลังตรวจสอบผู้ใช้…</div>
</header>

<div class="wrap">
  <div class="card">
    <h2>2.2 ตัวกรองการค้นหา</h2>
    <div class="muted">Tip: ใส่เงื่อนไขเท่าที่จำเป็น (ยิ่งแคบ ยิ่งเร็ว) • ระบบจะค้นจากข้อมูลที่ไม่ถูกลบ (deleted=false)</div>

    <div class="hr"></div>

    <h3>2.2.1 ค้นหาตามปีงบประมาณ</h3>
    <div class="row">
      <select id="fy">
        <option value="">ทุกปีงบฯ</option>
      </select>
      <select id="periodType">
        <option value="">ทุกงวด</option>
        <option value="YEAR">รายปี</option>
        <option value="QUARTER">รายไตรมาส</option>
        <option value="MONTH">รายเดือน</option>
        <option value="DAY">รายวัน</option>
      </select>
      <select id="periodValue">
        <option value="">ทุกค่า (งวด)</option>
      </select>
    </div>

    <div class="hr"></div>

    <h3>2.2.2 ค้นหาตามชื่อหน่วยรับตรวจ</h3>
    <div class="row">
      <select id="entityPick">
        <option value="">ทุกหน่วยรับตรวจ</option>
      </select>
      <input id="entityText" placeholder="พิมพ์ค้นหาจากคำ (เช่น ศรีสะเกษ / คำว่า “เทศบาล”)">
    </div>

    <div class="hr"></div>

    <h3>2.2.3 ค้นหาตามที่ตั้ง</h3>
    <div class="row">
      <input id="province" placeholder="จังหวัด (พิมพ์ได้ เช่น ศรีสะเกษ)" list="provList" />
      <datalist id="provList"></datalist>

      <input id="district" placeholder="อำเภอ (พิมพ์ได้)" list="distList" />
      <datalist id="distList"></datalist>

      <input id="subdistrict" placeholder="ตำบล (พิมพ์ได้)" list="subdList" />
      <datalist id="subdList"></datalist>
    </div>

    <div class="hr"></div>

    <h3>2.2.4 ค้นหาตามคำ (Keyword)</h3>
    <div class="row">
      <input id="keyword" placeholder="เช่น “อยู่ระหว่างตรวจสอบ”, “มีข้อสังเกต”, “ปรับปรุงบัญชี”">
      <select id="submitted">
        <option value="">รวมทั้งหมด (ส่ง/ไม่ส่ง)</option>
        <option value="Y">เฉพาะส่งแล้ว</option>
        <option value="N">เฉพาะยังไม่ส่ง</option>
      </select>
      <select id="lock">
        <option value="">รวมทั้งหมด (ล็อก/ไม่ล็อก)</option>
        <option value="OPEN">เฉพาะยังไม่ล็อก</option>
        <option value="LOCKED">เฉพาะล็อก (>=356 วัน)</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSearch">ค้นหา (ไปหน้า 2.3)</button>
      <button class="btn" id="btnPreview">พรีวิวผลแบบเร็ว</button>
      <button class="btn" id="btnReset">รีเซ็ต</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnTable">กลับตารางข้อมูลทั้งหมด</button>
      <button class="btn" id="btnHub">กลับ Data Hub</button>
      <button class="btn" id="btnCashboard">ไป Cashboard</button>
      <button class="btn" id="btnHome">กลับหน้าแรก</button>
    </div>

    <div class="msg okBox" id="ok"></div>
    <div class="msg warnBox" id="warn"></div>
    <div class="msg badBox" id="bad"></div>

    <div class="hr"></div>
    <div class="muted">
      <span class="pill info" id="dbCount">ฐานข้อมูล: 0 รายการ</span>
      <span class="pill info" id="matchCount">คาดว่าเข้าเงื่อนไข: —</span>
    </div>
  </div>
</div>

<script>
/* =========================
   0) Guard: login + ADMIN
   ========================= */
const SESSION_KEY = "fa_session_v1";
const session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
if(!session){ location.href="login.html"; }
const role = (session.role || "USER").toUpperCase();
if(role !== "ADMIN"){
  alert("หน้านี้สำหรับผู้ดูแลระบบ (ADMIN) เท่านั้น");
  location.href = "index.html";
}
document.getElementById("userBadge").textContent =
  "ผู้ใช้: " + (session.fullname || session.username) + " • บทบาท: " + role;

/* =========================
   1) Storage
   ========================= */
const RECORDS_KEY = "fa_manual_records_v1";
const SEARCH_CTX_KEY = "fa_admin_search_ctx_v1";

function getRecords(){ return JSON.parse(localStorage.getItem(RECORDS_KEY) || "[]"); }

/* =========================
   2) Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
function safe(v){ return (v===null||v===undefined) ? "" : String(v); }
function show(box, text){
  const el = $(box);
  el.textContent = text;
  el.style.display = "block";
  setTimeout(()=>{ el.style.display="none"; }, 2500);
}
function isLocked(created_at){
  if(!created_at) return false;
  const days = (Date.now() - created_at)/86400000;
  return days >= 356;
}
function contains(hay, q){
  if(!q) return true;
  return String(hay||"").toLowerCase().includes(q.toLowerCase());
}

/* =========================
   3) Init dropdowns
   ========================= */
(function initYear(){
  for(let y=2560;y<=2580;y++){
    const op=document.createElement("option");
    op.value=String(y); op.textContent="ปีงบฯ "+y;
    $("fy").appendChild(op);
  }
})();

function rebuildPeriodValue(){
  const t = $("periodType").value;
  const pv = $("periodValue");
  pv.innerHTML = `<option value="">ทุกค่า (งวด)</option>`;
  if(!t) return;

  if(t==="YEAR"){
    pv.innerHTML += `<option value="ALL">ทั้งปี</option>`;
  }
  if(t==="QUARTER"){
    ["Q1","Q2","Q3","Q4"].forEach(q=>{
      pv.innerHTML += `<option value="${q}">${q}</option>`;
    });
  }
  if(t==="MONTH"){
    for(let m=1;m<=12;m++){
      const mm=String(m).padStart(2,"0");
      pv.innerHTML += `<option value="${mm}">เดือน ${mm}</option>`;
    }
  }
  if(t==="DAY"){
    pv.innerHTML += `<option value="TODAY">รายวัน (TODAY)</option>`;
  }
}
$("periodType").addEventListener("change", ()=>{
  rebuildPeriodValue();
  calcPreview();
});
$("periodValue").addEventListener("change", calcPreview);
$("fy").addEventListener("change", calcPreview);

function buildFromDB(){
  const all = getRecords().filter(r=>!r.deleted);

  // entity list
  const pick = $("entityPick");
  pick.innerHTML = `<option value="">ทุกหน่วยรับตรวจ</option>`;
  const setEnt = new Set();
  all.forEach(r=>{
    const key = `${safe(r.entity?.type)}|${safe(r.entity?.name)}|${safe(r.entity?.province)}|${safe(r.entity?.district)}|${safe(r.entity?.subdistrict)}`;
    if(r.entity?.name) setEnt.add(key);
  });
  [...setEnt].sort((a,b)=>a.localeCompare(b,"th")).forEach(k=>{
    const [type,name,prov,dist,subd] = k.split("|");
    const op=document.createElement("option");
    op.value=k;
    op.textContent = `${type} ${name} • ${prov}/${dist}/${subd}`.trim();
    pick.appendChild(op);
  });

  // datalists
  const prov = $("provList"), dist = $("distList"), subd = $("subdList");
  prov.innerHTML=""; dist.innerHTML=""; subd.innerHTML="";
  const P=new Set(), D=new Set(), S=new Set();
  all.forEach(r=>{
    if(r.entity?.province) P.add(r.entity.province);
    if(r.entity?.district) D.add(r.entity.district);
    if(r.entity?.subdistrict) S.add(r.entity.subdistrict);
  });
  [...P].sort((a,b)=>a.localeCompare(b,"th")).forEach(v=>{ const o=document.createElement("option"); o.value=v; prov.appendChild(o); });
  [...D].sort((a,b)=>a.localeCompare(b,"th")).forEach(v=>{ const o=document.createElement("option"); o.value=v; dist.appendChild(o); });
  [...S].sort((a,b)=>a.localeCompare(b,"th")).forEach(v=>{ const o=document.createElement("option"); o.value=v; subd.appendChild(o); });

  $("dbCount").textContent = `ฐานข้อมูล: ${all.length} รายการ`;
}
buildFromDB();
rebuildPeriodValue();

/* =========================
   4) Build query + preview count
   ========================= */
function buildQuery(){
  const fy = $("fy").value || "";
  const periodType = $("periodType").value || "";
  const periodValue = $("periodValue").value || "";

  const entPick = $("entityPick").value || "";
  const entText = $("entityText").value.trim();

  const province = $("province").value.trim();
  const district = $("district").value.trim();
  const subdistrict = $("subdistrict").value.trim();

  const keyword = $("keyword").value.trim();
  const submitted = $("submitted").value || "";
  const lock = $("lock").value || "";

  return {
    fy, periodType, periodValue,
    entPick, entText,
    province, district, subdistrict,
    keyword, submitted, lock,
    ts: Date.now()
  };
}

function applyQuery(all, q){
  let arr = all.filter(r=>!r.deleted);

  if(q.fy) arr = arr.filter(r => String(r.period?.fiscalYear||"")===String(q.fy));
  if(q.periodType) arr = arr.filter(r => String(r.period?.periodType||"")===String(q.periodType));
  if(q.periodValue) arr = arr.filter(r => String(r.period?.periodValue||"")===String(q.periodValue));

  if(q.entPick){
    const [type,name,prov,dist,subd] = q.entPick.split("|");
    arr = arr.filter(r =>
      safe(r.entity?.type)===type &&
      safe(r.entity?.name)===name &&
      safe(r.entity?.province)===prov &&
      safe(r.entity?.district)===dist &&
      safe(r.entity?.subdistrict)===subd
    );
  }
  if(q.entText){
    arr = arr.filter(r=>{
      const hay = [r.entity?.type, r.entity?.name].join(" ");
      return contains(hay, q.entText);
    });
  }

  if(q.province) arr = arr.filter(r=>contains(r.entity?.province, q.province));
  if(q.district) arr = arr.filter(r=>contains(r.entity?.district, q.district));
  if(q.subdistrict) arr = arr.filter(r=>contains(r.entity?.subdistrict, q.subdistrict));

  if(q.submitted==="Y") arr = arr.filter(r=>!!r.submitted);
  if(q.submitted==="N") arr = arr.filter(r=>!r.submitted);

  if(q.lock==="LOCKED") arr = arr.filter(r=>isLocked(r.created_at));
  if(q.lock==="OPEN") arr = arr.filter(r=>!isLocked(r.created_at));

  if(q.keyword){
    arr = arr.filter(r=>{
      const hay = [
        r.s217, r.s218, r.s219, r.s2110,
        r.s214, r.s215, r.s216, r.s217_cash,
        r.s219_problem, r.s220_rec_type, r.s220_rec_text,
        JSON.stringify(r.details||{}),
        JSON.stringify(r.reportPack||{}),
        JSON.stringify(r.auditors||[]),
        JSON.stringify(r.reviewers||[])
      ].join(" ");
      return contains(hay, q.keyword);
    });
  }

  return arr;
}

function calcPreview(){
  const all = getRecords();
  const q = buildQuery();
  const m = applyQuery(all, q);
  $("matchCount").textContent = `คาดว่าเข้าเงื่อนไข: ${m.length} รายการ`;
}
["entityPick","entityText","province","district","subdistrict","keyword","submitted","lock"]
  .forEach(id=>{
    $(id).addEventListener("input", calcPreview);
    $(id).addEventListener("change", calcPreview);
  });

calcPreview();

/* =========================
   5) Buttons
   ========================= */
$("btnSearch").addEventListener("click", ()=>{
  const q = buildQuery();
  localStorage.setItem(SEARCH_CTX_KEY, JSON.stringify(q));
  location.href = "admin-manual-search-result.html";
});

$("btnPreview").addEventListener("click", ()=>{
  calcPreview();
  show("ok","พรีวิวผลแบบเร็วเรียบร้อย");
});

$("btnReset").addEventListener("click", ()=>{
  $("fy").value="";
  $("periodType").value="";
  rebuildPeriodValue();
  $("periodValue").value="";

  $("entityPick").value="";
  $("entityText").value="";

  $("province").value="";
  $("district").value="";
  $("subdistrict").value="";

  $("keyword").value="";
  $("submitted").value="";
  $("lock").value="";

  calcPreview();
  show("ok","รีเซ็ตเรียบร้อย");
});

$("btnTable").addEventListener("click", ()=>location.href="admin-manual-table.html");
$("btnHub").addEventListener("click", ()=>location.href="data-hub.html");
$("btnCashboard").addEventListener("click", ()=>location.href="cashboard.html");
$("btnHome").addEventListener("click", ()=>location.href="index.html");
</script>
</body>
</html>