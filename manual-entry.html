<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>บันทึก/แก้ไข/อัปเดตข้อมูล (Manual) • ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#dde3ee; --text:#29384d; --muted:#6a7c95;
      --brand:#1e5aaa; --brand2:#2f7de1; --shadow:0 10px 30px rgba(20,40,80,.08);
      --r:18px; --danger:#b13b3b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans";background:var(--bg);color:var(--text)}
    header{
      position:sticky; top:0; z-index:10;
      background:#fff; border-bottom:1px solid var(--line);
      padding:14px 18px; display:flex; align-items:center; gap:12px;
    }
    .title{display:flex;flex-direction:column;line-height:1.05}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .spacer{flex:1}
    .badge{border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa;padding:8px 12px;border-radius:14px;font-weight:900}

    .wrap{max-width:1300px;margin:18px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;min-width:0}
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:14px 0 8px;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    label{font-weight:900;font-size:13px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-size:14px;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:220px}
    .btn{
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:10px 12px; cursor:pointer; font-weight:900; color:var(--text);
    }
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; border-color:transparent}
    .btn.danger{background:#fff0f0;border-color:#ffd2d2;color:var(--danger)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;font-weight:900}
    .ok{border:1px solid #c8f2d6;background:#effaf3;color:#1f7a3b}
    .bad{border:1px solid #ffd2d2;background:#fff0f0;color:var(--danger)}
    .warn{border:1px solid #ffe7b8;background:#fff7e6;color:#8a5a00}

    .section{margin-top:12px;padding-top:12px;border-top:1px dashed #e2e8f2}
    .mini{font-size:12px;color:#7b8dab}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa}
    .locked{border:1px solid #ffd2d2;background:#fff0f0;color:var(--danger);padding:10px 12px;border-radius:14px;font-weight:900;margin-top:10px;display:none}
    .gridSmall{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tablelike{display:grid;gap:10px}
    .person{background:#f7f9fc;border:1px solid #e6ecf6;border-radius:14px;padding:10px}
    .person .gridSmall{margin-top:8px}

    .rightBox{position:sticky;top:92px;height:calc(100vh - 110px);overflow:auto}
    .kv{display:flex;justify-content:space-between;gap:10px;margin:8px 0}
    .kv b{white-space:nowrap}
    .kv span{color:var(--muted);text-align:right}
    .hr{height:1px;background:#eef2f7;margin:10px 0}

    @media (max-width:1100px){
      .grid{grid-template-columns:1fr}
      .rightBox{position:relative;top:auto;height:auto}
      .row > div{min-width:180px}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>บันทึก/แก้ไข/อัปเดตข้อมูล (Manual Data Entry)</h1>
    <small>ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์ • ข้อมูล 2.1.1–2.1.20</small>
  </div>
  <div class="spacer"></div>
  <div class="badge" id="userBadge">กำลังตรวจสอบสถานะผู้ใช้…</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: FORM -->
    <main class="card">
      <h2>กำหนด “ชุดข้อมูล” ที่ต้องการบันทึก/แก้ไข</h2>
      <div class="muted">
        เลือก <b>หน่วยรับตรวจ + ปีงบประมาณ + งวด</b> แล้วกด “โหลด/เริ่มบันทึก” ระบบจะโหลดเรคคอร์ดเดิมให้ (ถ้ามี)  
        และจะ <b>ล็อกการแก้ไขเมื่อครบ 356 วัน</b> นับจากวันที่บันทึกครั้งแรกของชุดข้อมูลนั้น
      </div>

      <div class="section">
        <h3>2.1.1 หน่วยรับตรวจ (พร้อมที่ตั้ง)</h3>
        <div class="row">
          <div>
            <label>ประเภทหน่วย (ตัวอย่าง)</label>
            <select id="entityType">
              <option value="อบจ.">อบจ.</option>
              <option value="ทม.">ทม.</option>
              <option value="ทน.">ทน.</option>
              <option value="ทต.">ทต.</option>
              <option value="อบต." selected>อบต.</option>
              <option value="อื่นๆ">อื่นๆ</option>
            </select>
          </div>
          <div>
            <label>ชื่อหน่วยรับตรวจ (พิมพ์ค้นหา/กรอกเอง)</label>
            <input id="entityName" placeholder="เช่น เทศบาลเมือง..., อบต...." list="entityNameList" />
            <datalist id="entityNameList"></datalist>
            <div class="mini">* เฟสแรกใช้รายการตัวอย่าง + กรอกเองได้ (เฟสถัดไปค่อยเชื่อมฐานข้อมูล อปท. ทั้งประเทศ)</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>จังหวัด</label>
            <select id="province"></select>
          </div>
          <div>
            <label>อำเภอ</label>
            <input id="district" placeholder="พิมพ์อำเภอ (เฟสถัดไปทำเป็น dropdown)" />
          </div>
          <div>
            <label>ตำบล</label>
            <input id="subdistrict" placeholder="พิมพ์ตำบล (เฟสถัดไปทำเป็น dropdown)" />
          </div>
        </div>
      </div>

      <div class="section">
        <h3>2.1.2 ปีงบประมาณ / งวด / วันเวลา</h3>
        <div class="row">
          <div>
            <label>ปีงบประมาณ</label>
            <select id="fiscalYear"></select>
          </div>
          <div>
            <label>งวด</label>
            <select id="periodType">
              <option value="YEAR">รายปี</option>
              <option value="QUARTER" selected>รายไตรมาส</option>
              <option value="MONTH">รายเดือน</option>
              <option value="DAY">รายวัน</option>
            </select>
          </div>
          <div>
            <label>ค่า “งวด”</label>
            <select id="periodValue"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>วันที่-เวลาบันทึก/แก้ไข (อัตโนมัติ)</label>
            <input id="nowStamp" disabled />
          </div>
          <div style="display:flex;align-items:end;gap:10px">
            <button class="btn primary" id="btnLoad">โหลด/เริ่มบันทึก</button>
            <button class="btn" id="btnNew">เริ่มชุดใหม่</button>
          </div>
        </div>

        <div class="locked" id="lockedBox">
          ชุดข้อมูลนี้ถูกล็อก (ครบ 356 วันจากวันที่บันทึกครั้งแรก) — สามารถดูข้อมูลได้ แต่ไม่สามารถแก้ไขได้
        </div>
      </div>

      <div class="section">
        <h3>2.1.3 ผู้ตรวจสอบ (เพิ่มได้ 5 คน)</h3>
        <div class="tablelike" id="auditors"></div>
        <div class="row">
          <button class="btn" id="addAuditor">+ เพิ่มผู้ตรวจสอบ</button>
        </div>
      </div>

      <div class="section">
        <h3>2.1.4 ผู้สอบทาน (เพิ่มได้ 2 คน)</h3>
        <div class="tablelike" id="reviewers"></div>
        <div class="row">
          <button class="btn" id="addReviewer">+ เพิ่มผู้สอบทาน</button>
        </div>
      </div>

      <div class="section">
        <h3>2.1.5 ผู้อำนวยการสำนัก (1 คน)</h3>
        <div class="tablelike" id="director"></div>
      </div>

      <div class="section">
        <h3>2.1.6 ผู้รับตรวจ (1 คน)</h3>
        <div class="tablelike" id="auditee"></div>
      </div>

      <div class="section">
        <h2>สถานะ/ผล/ปัญหา/ข้อเสนอแนะ (2.1.7–2.1.20)</h2>

        <h3>2.1.7 สถานะการตรวจสอบ FA</h3>
        <select id="status217">
          <option>ยุติการติดตามผล</option>
          <option>อยู่ระหว่างติดตามผลการตรวจสอบ</option>
          <option>ออกรายงานการตรวจแล้ว</option>
          <option>อยู่ระหว่างจัดพิมพ์รายงาน</option>
          <option>อยู่ระหว่างสอบทานของ ผตจ.</option>
          <option>อยู่ระหว่างสอบทาน ผอก.</option>
          <option selected>อยู่ระหว่างตรวจสอบ</option>
          <option>ยังไม่ตรวจ</option>
          <option>ไม่ทราบสถานะ</option>
        </select>

        <h3>2.1.8 สถานะการปิดงบการเงิน</h3>
        <select id="status218">
          <option selected>ปิดงบการเงินแล้ว</option>
          <option>ยังไม่ปิดงบการเงิน</option>
          <option>ไม่ทราบสถานะ</option>
        </select>

        <h3>2.1.9 สถานะการส่งรายงานการเงิน</h3>
        <select id="status219">
          <option selected>ส่งรายงานการเงินแล้ว</option>
          <option>ยังไม่ส่งรายงานการเงิน</option>
          <option>ไม่ทราบสถานะ</option>
        </select>

        <h3>2.1.10 สถานะการส่งหนังสือติดตามการส่งรายงานการเงิน</h3>
        <select id="status2110">
          <option>จัดทำหนังสือแล้ว</option>
          <option selected>ยังไม่จัดทำหนังสือ</option>
          <option>ไม่ทราบสถานะ</option>
        </select>

        <div class="section">
          <h3>2.1.12 การประชุมปิดตรวจสอบ FA</h3>
          <select id="closeMeeting212">
            <option selected>ยังไม่ประชุมปิดตรวจ</option>
            <option>ประชุมปิดตรวจสอบแล้ว</option>
            <option>ไม่ทราบ</option>
            <option>ยังตรวจสอบไม่เสร็จ</option>
          </select>
        </div>

        <div class="section">
          <h3>2.1.14 ผลการตรวจสอบ FA</h3>
          <select id="opinion214">
            <option>แบบไม่มีเงื่อนไข</option>
            <option>แบบมีเงื่อนไข</option>
            <option>ไม่รับรองรายงาน</option>
            <option>ไม่ให้ความเห็น</option>
            <option>ไม่ทราบ</option>
            <option selected>ยังไม่ออกรายงาน</option>
          </select>

          <h3>2.1.15 ข้อสังเกตการตรวจสอบ FA</h3>
          <select id="finding215">
            <option selected>ไม่มีข้อสังเกต</option>
            <option>มีข้อสังเกต</option>
            <option>ไม่ทราบ</option>
            <option>ยังไม่ออกรายงาน</option>
          </select>

          <h3>2.1.16 การปรับปรุงบัญชี</h3>
          <select id="adjust216">
            <option>มีการปรับปรุงมากกว่า 51 รายการ</option>
            <option>มีการปรับปรุง 40-50 รายการ</option>
            <option>มีการปรับปรุง 30-39 รายการ</option>
            <option>มีการปรับปรุง 20-29 รายการ</option>
            <option>มีการปรับปรุง 10-19 รายการ</option>
            <option>มีการปรับปรุง 5-9 รายการ</option>
            <option>มีการปรับปรุงน้อยกว่า 5 รายการ</option>
            <option selected>ไม่มีการปรับปรุง</option>
            <option>ยังไม่ทราบ</option>
          </select>

          <h3>2.1.17 เงินขาดบัญชี</h3>
          <select id="cashShort217">
            <option selected>ไม่มี</option>
            <option>มี</option>
            <option>ยังไม่ทราบ</option>
          </select>
        </div>

        <div class="section">
          <h3>2.1.19 ปัญหาการตรวจ FA</h3>
          <select id="problem219">
            <option>มีปัญหาเรื่องคน</option>
            <option>มีปัญหาเรื่องงาน</option>
            <option>มีปัญหาเรื่องระยะเวลา</option>
            <option>มีปัญหาเรื่องเครื่องมืออุปกรณ์</option>
            <option>มีปัญหาเรื่องงบประมาณ</option>
            <option>มีปัญหาเรื่องหน่วยรับตรวจ</option>
            <option selected>ไม่มีปัญหาเรื่อง</option>
            <option>ไม่ทราบ</option>
          </select>

          <h3>2.1.20 ข้อเสนอแนะ FA</h3>
          <div class="muted">เลือกประเภทข้อเสนอแนะ และพิมพ์รายละเอียด (ถ้ามี)</div>
          <select id="recType220">
            <option selected>แก้ไขปัญหาเรื่องคน</option>
            <option>แก้ไขปัญหาเรื่องงาน</option>
            <option>แก้ไขปัญหาเรื่องระยะเวลา</option>
            <option>แก้ไขปัญหาเรื่องเครื่องมืออุปกรณ์</option>
            <option>แก้ไขปัญหาเรื่องงบประมาณ</option>
            <option>แก้ไขปัญหาเรื่องหน่วยรับตรวจ</option>
            <option>แก้ไขปัญหาอื่นๆ</option>
          </select>
          <textarea id="recText220" placeholder="พิมพ์รายละเอียดข้อเสนอแนะ (ถ้ามี)"></textarea>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="section">
        <div class="row">
          <button class="btn primary" id="btnSave">บันทึกข้อมูล</button>
          <button class="btn" id="btnView">ดูผลการบันทึกข้อมูล</button>
          <button class="btn primary" id="btnSubmit">ส่งข้อมูลเข้าระบบ</button>
          <button class="btn" id="btnEdit">กลับไปแก้ไขข้อมูล</button>
          <button class="btn" onclick="location.href='cashboard.html'">ไปหน้า Cashboard</button>
          <button class="btn" onclick="location.href='index.html'">กลับไปหน้าหลัก</button>
        </div>

        <div class="msg ok" id="ok"></div>
        <div class="msg bad" id="bad"></div>
        <div class="msg warn" id="warn"></div>
      </div>
    </main>

    <!-- RIGHT: SUMMARY / STATUS -->
    <aside class="card rightBox">
      <h2>สรุปชุดข้อมูล</h2>
      <div class="kv"><b>หน่วยรับตรวจ</b><span id="sumEntity">-</span></div>
      <div class="kv"><b>ที่ตั้ง</b><span id="sumLoc">-</span></div>
      <div class="kv"><b>ปีงบฯ/งวด</b><span id="sumPeriod">-</span></div>
      <div class="hr"></div>
      <div class="kv"><b>สร้างครั้งแรก</b><span id="sumCreated">-</span></div>
      <div class="kv"><b>แก้ไขล่าสุด</b><span id="sumUpdated">-</span></div>
      <div class="kv"><b>สถานะล็อก</b><span id="sumLock">-</span></div>
      <div class="hr"></div>
      <h3>สถานะสำคัญ (2.1.7–2.1.20)</h3>
      <div class="kv"><b>2.1.7</b><span id="sum217">-</span></div>
      <div class="kv"><b>2.1.8</b><span id="sum218">-</span></div>
      <div class="kv"><b>2.1.9</b><span id="sum219">-</span></div>
      <div class="kv"><b>2.1.10</b><span id="sum2110">-</span></div>
      <div class="kv"><b>2.1.14</b><span id="sum214">-</span></div>
      <div class="kv"><b>2.1.15</b><span id="sum215">-</span></div>
      <div class="kv"><b>2.1.16</b><span id="sum216">-</span></div>
      <div class="kv"><b>2.1.17</b><span id="sum217c">-</span></div>
      <div class="kv"><b>2.1.19</b><span id="sum219p">-</span></div>
      <div class="kv"><b>2.1.20</b><span id="sum220">-</span></div>

      <div class="section">
        <h3>ลิงก์ที่เกี่ยวข้อง</h3>
        <div class="row">
          <button class="btn" onclick="location.href='upload.html'">ไปหน้าอัปโหลด</button>
          <button class="btn" onclick="location.href='manual-review.html'">ไปหน้าตรวจทาน/ส่งข้อมูล</button>
          <button class="btn" onclick="location.href='vault-overview.html'">ไปคลังข้อมูล (ภาพรวม)</button>
        </div>
        <div class="mini">* ไฟล์บางหน้าจะสร้างให้ต่อในลำดับถัดไป</div>
      </div>
    </aside>

  </div>
</div>

<script>
/* =========================
   A) Auth guard
   ========================= */
const SESSION_KEY = "fa_session_v1";
const session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
if(!session){ location.href="login.html"; }
document.getElementById("userBadge").textContent =
  "ผู้ใช้: " + (session.fullname || session.username) + " • บทบาท: " + (session.role || "USER");

/* =========================
   B) Storage keys
   ========================= */
const RECORDS_KEY = "fa_manual_records_v1";   // array of records
const SUBMIT_KEY  = "fa_manual_submissions_v1"; // audit submit log

/* =========================
   C) Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
function nowStr(){ return new Date().toLocaleString(); }
function isoNow(){ return Date.now(); }
function show(kind, text){
  ["ok","bad","warn"].forEach(k=>{ $(k).style.display="none"; $(k).textContent=""; });
  const el = $(kind);
  el.textContent = text;
  el.style.display="block";
  setTimeout(()=>{ el.style.display="none"; }, 2600);
}
function ymd(ts){
  if(!ts) return "-";
  return new Date(ts).toLocaleString();
}
function safe(s){ return (s===null||s===undefined||s==="") ? "-" : String(s); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

/* =========================
   D) Year / Period / Province init
   ========================= */
(function initYears(){
  const fy = $("fiscalYear");
  for(let y=2560;y<=2580;y++){
    const op=document.createElement("option");
    op.value=y; op.textContent=String(y);
    if(y===2568) op.selected=true;
    fy.appendChild(op);
  }
})();
const provinceList = [
  "กรุงเทพมหานคร","กระบี่","กาญจนบุรี","กาฬสินธุ์","กำแพงเพชร","ขอนแก่น","จันทบุรี","ฉะเชิงเทรา","ชลบุรี","ชัยนาท",
  "ชัยภูมิ","ชุมพร","เชียงราย","เชียงใหม่","ตรัง","ตราด","ตาก","นครนายก","นครปฐม","นครพนม",
  "นครราชสีมา","นครศรีธรรมราช","นครสวรรค์","นนทบุรี","นราธิวาส","น่าน","บึงกาฬ","บุรีรัมย์","ปทุมธานี","ประจวบคีรีขันธ์",
  "ปราจีนบุรี","ปัตตานี","พระนครศรีอยุธยา","พะเยา","พังงา","พัทลุง","พิจิตร","พิษณุโลก","เพชรบุรี","เพชรบูรณ์",
  "แพร่","ภูเก็ต","มหาสารคาม","มุกดาหาร","แม่ฮ่องสอน","ยโสธร","ยะลา","ร้อยเอ็ด","ระนอง","ระยอง",
  "ราชบุรี","ลพบุรี","ลำปาง","ลำพูน","เลย","ศรีสะเกษ","สกลนคร","สงขลา","สตูล","สมุทรปราการ",
  "สมุทรสงคราม","สมุทรสาคร","สระแก้ว","สระบุรี","สิงห์บุรี","สุโขทัย","สุพรรณบุรี","สุราษฎร์ธานี","สุรินทร์","หนองคาย",
  "หนองบัวลำภู","อ่างทอง","อำนาจเจริญ","อุดรธานี","อุตรดิตถ์","อุทัยธานี","อุบลราชธานี"
];
(function initProvince(){
  const p=$("province");
  provinceList.forEach((name)=>{
    const op=document.createElement("option");
    op.value=name; op.textContent=name;
    if(name==="ศรีสะเกษ") op.selected=true;
    p.appendChild(op);
  });
})();

function refreshPeriodValue(){
  const pt = $("periodType").value;
  const pv = $("periodValue");
  pv.innerHTML="";
  const add=(v,t=v)=>{ const op=document.createElement("option"); op.value=v; op.textContent=t; pv.appendChild(op); };
  if(pt==="YEAR"){ add("FY","ทั้งปี"); }
  if(pt==="QUARTER"){ ["Q1","Q2","Q3","Q4"].forEach(q=>add(q,q)); }
  if(pt==="MONTH"){ for(let m=1;m<=12;m++) add(String(m).padStart(2,"0"), "เดือน " + m); }
  if(pt==="DAY"){ add("TODAY","วันนี้"); add("CUSTOM","ระบุวัน (ใช้เวลาบันทึก)"); }
}
$("periodType").addEventListener("change", refreshPeriodValue);
refreshPeriodValue();

setInterval(()=>{ $("nowStamp").value = nowStr(); }, 1000);

/* =========================
   E) Entity suggestions (sample)
   ========================= */
(function seedEntityDatalist(){
  const dl = $("entityNameList");
  const samples = [
    "เทศบาลเมืองศรีสะเกษ","เทศบาลตำบลห้วยทับทัน","องค์การบริหารส่วนตำบลโพธิ์","องค์การบริหารส่วนตำบลเมืองแคน",
    "องค์การบริหารส่วนจังหวัดศรีสะเกษ","เทศบาลนครอุบลราชธานี"
  ];
  samples.forEach(s=>{
    const op=document.createElement("option"); op.value=s; dl.appendChild(op);
  });
})();

/* =========================
   F) People blocks
   ========================= */
function personBlock(roleKey, idx, title){
  const wrap=document.createElement("div");
  wrap.className="person";
  wrap.dataset.role=roleKey;
  wrap.dataset.idx=idx;

  wrap.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <b>${title}</b>
      <button class="btn danger btnRemove" type="button">ลบ</button>
    </div>
    <div class="gridSmall">
      <div>
        <label>ชื่อ-สกุล</label>
        <input class="p_name" placeholder="ชื่อ-สกุล" />
      </div>
      <div>
        <label>ตำแหน่ง</label>
        <input class="p_pos" placeholder="ตำแหน่ง" />
      </div>
      <div>
        <label>สังกัดกลุ่มที่</label>
        <select class="p_group">
          ${Array.from({length:10},(_,i)=>`<option value="กลุ่มตรวจสอบที่ ${i+1}">กลุ่มตรวจสอบที่ ${i+1}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>สังกัดสำนักงาน</label>
        <input class="p_office" placeholder="เช่น สตง. จังหวัด..." />
      </div>
      <div>
        <label>วันที่ได้รับมอบหมาย/วันที่ดำรงตำแหน่ง</label>
        <input class="p_date" type="date" />
      </div>
      <div>
        <label>หน้าที่รับผิดชอบ (สำหรับผู้ตรวจ)</label>
        <input class="p_duty" placeholder="เช่น ตรวจรายได้/รายจ่าย/สินทรัพย์" />
      </div>
    </div>
  `;
  wrap.querySelector(".btnRemove").addEventListener("click", ()=>{
    wrap.remove();
    updateSummary();
  });
  return wrap;
}

function renderPeople(){
  const aud = $("auditors");
  const rev = $("reviewers");
  const dir = $("director");
  const auditee = $("auditee");

  aud.innerHTML=""; rev.innerHTML=""; dir.innerHTML=""; auditee.innerHTML="";
  // default rows
  aud.appendChild(personBlock("auditor",0,"ผู้ตรวจสอบ #1"));
  rev.appendChild(personBlock("reviewer",0,"ผู้สอบทาน #1"));

  const d = personBlock("director",0,"ผู้อำนวยการสำนัก");
  d.querySelector(".btnRemove").style.display="none";
  dir.appendChild(d);

  const a = personBlock("auditee",0,"ผู้รับตรวจ");
  a.querySelector(".btnRemove").style.display="none";
  auditee.appendChild(a);
}
renderPeople();

$("addAuditor").addEventListener("click", ()=>{
  const c=$("auditors").children.length;
  if(c>=5){ show("warn","เพิ่มผู้ตรวจสอบได้ไม่เกิน 5 คน"); return; }
  $("auditors").appendChild(personBlock("auditor",c,`ผู้ตรวจสอบ #${c+1}`));
});
$("addReviewer").addEventListener("click", ()=>{
  const c=$("reviewers").children.length;
  if(c>=2){ show("warn","เพิ่มผู้สอบทานได้ไม่เกิน 2 คน"); return; }
  $("reviewers").appendChild(personBlock("reviewer",c,`ผู้สอบทาน #${c+1}`));
});

/* =========================
   G) Record identity & lock logic (356 days)
   ========================= */
function buildRecordId(){
  const t = $("entityType").value.trim();
  const n = $("entityName").value.trim();
  const p = $("province").value.trim();
  const d = $("district").value.trim();
  const s = $("subdistrict").value.trim();
  const fy = $("fiscalYear").value;
  const pt = $("periodType").value;
  const pv = $("periodValue").value;
  // ทำให้ ID คงที่เพื่อโหลด/แก้ไขได้
  return [
    "REC", t, n, p, d, s, "FY"+fy, pt+pv
  ].map(x=>String(x||"").replace(/\s+/g,"_")).join("|");
}

function getRecords(){
  return JSON.parse(localStorage.getItem(RECORDS_KEY) || "[]");
}
function saveRecords(arr){
  localStorage.setItem(RECORDS_KEY, JSON.stringify(arr));
}

function isLocked(created_at){
  if(!created_at) return false;
  const days = (Date.now() - created_at) / 86400000;
  return days >= 356; // ตามที่กำหนด
}

/* =========================
   H) Form read/write
   ========================= */
let activeRecord = null; // loaded record object
let readOnly = false;

function readPeople(containerId){
  const boxes = Array.from($(containerId).querySelectorAll(".person"));
  return boxes.map(b=>({
    name: b.querySelector(".p_name").value.trim(),
    position: b.querySelector(".p_pos").value.trim(),
    group: b.querySelector(".p_group").value,
    office: b.querySelector(".p_office").value.trim(),
    assigned_date: b.querySelector(".p_date").value || "",
    duty: b.querySelector(".p_duty").value.trim()
  })).filter(x=> x.name || x.position || x.office || x.duty || x.assigned_date);
}
function writePeople(containerId, arr, roleKey, max, label){
  const container = $(containerId);
  container.innerHTML="";
  const take = (arr||[]).slice(0,max);
  if(take.length===0){
    // fallback default row
    const b = personBlock(roleKey,0,label+" #1");
    if(roleKey==="director"||roleKey==="auditee") b.querySelector(".btnRemove").style.display="none";
    container.appendChild(b);
    return;
  }
  take.forEach((p,i)=>{
    const b = personBlock(roleKey,i, (max===1?label: `${label} #${i+1}`));
    if(roleKey==="director"||roleKey==="auditee") b.querySelector(".btnRemove").style.display="none";
    b.querySelector(".p_name").value = p.name||"";
    b.querySelector(".p_pos").value = p.position||"";
    b.querySelector(".p_group").value = p.group || "กลุ่มตรวจสอบที่ 1";
    b.querySelector(".p_office").value = p.office||"";
    b.querySelector(".p_date").value = p.assigned_date||"";
    b.querySelector(".p_duty").value = p.duty||"";
    container.appendChild(b);
  });
}

function collectForm(){
  const rec = {
    id: buildRecordId(),

    entity: {
      type: $("entityType").value,
      name: $("entityName").value.trim(),
      province: $("province").value,
      district: $("district").value.trim(),
      subdistrict: $("subdistrict").value.trim()
    },

    period: {
      fiscalYear: Number($("fiscalYear").value),
      periodType: $("periodType").value,
      periodValue: $("periodValue").value
    },

    // people
    auditors: readPeople("auditors").slice(0,5),
    reviewers: readPeople("reviewers").slice(0,2),
    director: readPeople("director").slice(0,1),
    auditee: readPeople("auditee").slice(0,1),

    // statuses 2.1.7-2.1.20 (subset that you required explicitly)
    s217: $("status217").value,
    s218: $("status218").value,
    s219: $("status219").value,
    s2110: $("status2110").value,
    s212: $("closeMeeting212").value,
    s214: $("opinion214").value,
    s215: $("finding215").value,
    s216: $("adjust216").value,
    s217_cash: $("cashShort217").value,
    s219_problem: $("problem219").value,
    s220_rec_type: $("recType220").value,
    s220_rec_text: $("recText220").value.trim(),

    // audit meta
    created_at: activeRecord?.created_at || Date.now(),
    updated_at: Date.now(),
    created_by: activeRecord?.created_by || (session.fullname || session.username),
    updated_by: (session.fullname || session.username),

    // submit meta
    submitted: activeRecord?.submitted || false,
    submitted_at: activeRecord?.submitted_at || null
  };
  return rec;
}

function applyForm(rec){
  // entity
  $("entityType").value = rec.entity?.type || "อบต.";
  $("entityName").value = rec.entity?.name || "";
  $("province").value = rec.entity?.province || $("province").value;
  $("district").value = rec.entity?.district || "";
  $("subdistrict").value = rec.entity?.subdistrict || "";

  // period
  $("fiscalYear").value = String(rec.period?.fiscalYear || 2568);
  $("periodType").value = rec.period?.periodType || "QUARTER";
  refreshPeriodValue();
  $("periodValue").value = rec.period?.periodValue || $("periodValue").value;

  // people
  writePeople("auditors", rec.auditors, "auditor", 5, "ผู้ตรวจสอบ");
  writePeople("reviewers", rec.reviewers, "reviewer", 2, "ผู้สอบทาน");
  writePeople("director", rec.director, "director", 1, "ผู้อำนวยการสำนัก");
  writePeople("auditee", rec.auditee, "auditee", 1, "ผู้รับตรวจ");

  // statuses
  $("status217").value = rec.s217 || $("status217").value;
  $("status218").value = rec.s218 || $("status218").value;
  $("status219").value = rec.s219 || $("status219").value;
  $("status2110").value = rec.s2110 || $("status2110").value;
  $("closeMeeting212").value = rec.s212 || $("closeMeeting212").value;
  $("opinion214").value = rec.s214 || $("opinion214").value;
  $("finding215").value = rec.s215 || $("finding215").value;
  $("adjust216").value = rec.s216 || $("adjust216").value;
  $("cashShort217").value = rec.s217_cash || $("cashShort217").value;
  $("problem219").value = rec.s219_problem || $("problem219").value;
  $("recType220").value = rec.s220_rec_type || $("recType220").value;
  $("recText220").value = rec.s220_rec_text || "";

  activeRecord = rec;
  setReadOnly(isLocked(rec.created_at));
  updateSummary();
}

function setReadOnly(flag){
  readOnly = !!flag;
  $("lockedBox").style.display = readOnly ? "block" : "none";

  // disable inputs if locked
  const inputs = document.querySelectorAll("main input, main select, main textarea, main button");
  inputs.forEach(el=>{
    // allow navigation buttons always
    const id = el.id || "";
    const allow = ["btnView","btnEdit","btnLoad","btnNew"].includes(id) || el.getAttribute("onclick");
    if(allow) return;

    if(el.tagName==="BUTTON"){
      if(["btnSave","btnSubmit","addAuditor","addReviewer"].includes(id)) el.disabled = readOnly;
    }else{
      el.disabled = readOnly;
    }
  });

  // remove buttons inside person blocks
  document.querySelectorAll(".btnRemove").forEach(b=>{
    b.style.display = readOnly ? "none" : "inline-block";
  });
}

/* =========================
   I) Load / New / Save / View / Submit
   ========================= */
function validateKeyFields(){
  if(!$("entityName").value.trim()) { show("bad","กรุณากรอกชื่อหน่วยรับตรวจ"); return false; }
  return true;
}

$("btnLoad").addEventListener("click", ()=>{
  if(!validateKeyFields()) return;

  const id = buildRecordId();
  const records = getRecords();
  const found = records.find(r=>r.id===id);

  if(found){
    applyForm(found);
    show("ok","โหลดข้อมูลเดิมเรียบร้อย");
  }else{
    activeRecord = null;
    setReadOnly(false);
    updateSummary();
    show("ok","ยังไม่มีข้อมูลเดิม — เริ่มบันทึกชุดใหม่ได้เลย");
  }
});

$("btnNew").addEventListener("click", ()=>{
  activeRecord = null;
  setReadOnly(false);
  renderPeople();
  $("recText220").value="";
  show("ok","เริ่มชุดใหม่เรียบร้อย");
  updateSummary();
});

$("btnSave").addEventListener("click", ()=>{
  if(readOnly){ show("bad","ไม่สามารถบันทึกได้: ชุดข้อมูลถูกล็อกครบ 356 วันแล้ว"); return; }
  if(!validateKeyFields()) return;

  const rec = collectForm();
  const records = getRecords();
  const idx = records.findIndex(r=>r.id===rec.id);
  if(idx>=0) records[idx]=rec; else records.push(rec);
  saveRecords(records);

  activeRecord = rec;
  setReadOnly(isLocked(rec.created_at));
  updateSummary();
  show("ok","บันทึกข้อมูลเรียบร้อย ✅");
});

$("btnView").addEventListener("click", ()=>{
  if(!validateKeyFields()) return;
  const id = buildRecordId();
  const records = getRecords();
  const found = records.find(r=>r.id===id) || collectForm();
  // modal simple
  const text = JSON.stringify(found, null, 2);
  const w = window.open("", "_blank");
  w.document.write(`<pre style="white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Menlo,Consolas; padding:14px">${escapeHtml(text)}</pre>`);
  show("ok","เปิดหน้าดูผลการบันทึกข้อมูลแล้ว");
});

$("btnSubmit").addEventListener("click", ()=>{
  if(readOnly){ show("bad","ไม่สามารถส่งได้: ชุดข้อมูลถูกล็อกครบ 356 วันแล้ว"); return; }
  if(!validateKeyFields()) return;

  // ต้องบันทึกก่อนเพื่อให้มี created_at คงที่
  const rec = collectForm();
  let records = getRecords();
  const idx = records.findIndex(r=>r.id===rec.id);
  if(idx>=0){
    rec.created_at = records[idx].created_at;
    rec.created_by = records[idx].created_by;
  }
  rec.submitted = true;
  rec.submitted_at = Date.now();
  rec.updated_at = Date.now();

  if(idx>=0) records[idx]=rec; else records.push(rec);
  saveRecords(records);

  // submit log
  const log = JSON.parse(localStorage.getItem(SUBMIT_KEY) || "[]");
  log.push({ id: rec.id, submitted_at: rec.submitted_at, by: (session.fullname||session.username) });
  localStorage.setItem(SUBMIT_KEY, JSON.stringify(log));

  activeRecord = rec;
  setReadOnly(isLocked(rec.created_at));
  updateSummary();
  show("ok","ส่งข้อมูลเรียบร้อย ✅ (พร้อมให้ Cashboard ดึงไปแสดง)");
});

$("btnEdit").addEventListener("click", ()=>{
  if(!activeRecord){ show("warn","ยังไม่ได้โหลด/สร้างเรคคอร์ด — สามารถแก้ไขในฟอร์มได้ทันที"); return; }
  if(isLocked(activeRecord.created_at)){
    show("bad","ชุดข้อมูลนี้ถูกล็อก (ครบ 356 วัน) ไม่สามารถกลับไปแก้ไขได้");
    setReadOnly(true);
    return;
  }
  setReadOnly(false);
  show("ok","เข้าสู่โหมดแก้ไขข้อมูลแล้ว");
});

/* =========================
   J) Summary side panel
   ========================= */
function updateSummary(){
  const name = $("entityName").value.trim();
  const et = $("entityType").value;
  const loc = `${$("province").value} / ${$("district").value||"-"} / ${$("subdistrict").value||"-"}`;
  const fy = $("fiscalYear").value;
  const pt = $("periodType").value;
  const pv = $("periodValue").value;
  const ptLabel = (pt==="YEAR"?"รายปี":pt==="QUARTER"?"รายไตรมาส":pt==="MONTH"?"รายเดือน":"รายวัน");

  $("sumEntity").textContent = safe(et+" "+name);
  $("sumLoc").textContent = safe(loc);
  $("sumPeriod").textContent = safe(`ปีงบฯ ${fy} • ${ptLabel} ${pv}`);

  const created = activeRecord?.created_at || null;
  const updated = activeRecord?.updated_at || null;

  $("sumCreated").textContent = created ? ymd(created) : "-";
  $("sumUpdated").textContent = updated ? ymd(updated) : "-";
  const locked = created ? (isLocked(created) ? "ล็อกแล้ว" : "แก้ไขได้") : "ยังไม่บันทึก";
  $("sumLock").textContent = locked;

  $("sum217").textContent = $("status217").value;
  $("sum218").textContent = $("status218").value;
  $("sum219").textContent = $("status219").value;
  $("sum2110").textContent = $("status2110").value;
  $("sum214").textContent = $("opinion214").value;
  $("sum215").textContent = $("finding215").value;
  $("sum216").textContent = $("adjust216").value;
  $("sum217c").textContent = $("cashShort217").value;
  $("sum219p").textContent = $("problem219").value;

  const rec = $("recType220").value + ( $("recText220").value.trim() ? " • " + $("recText220").value.trim().slice(0,60) : "" );
  $("sum220").textContent = rec;
}

["entityType","entityName","province","district","subdistrict","fiscalYear","periodType","periodValue",
 "status217","status218","status219","status2110","closeMeeting212","opinion214","finding215","adjust216","cashShort217",
 "problem219","recType220","recText220"
].forEach(id=>{
  $(id).addEventListener("input", updateSummary);
  $(id).addEventListener("change", updateSummary);
});
updateSummary();

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>
