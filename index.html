<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์ • หน้าแรก</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --line:#dde3ee; --text:#29384d; --muted:#6a7c95;
      --brand:#1e5aaa; --brand2:#2f7de1;
      --shadow: 0 10px 30px rgba(20,40,80,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#fff; border-bottom:1px solid var(--line);
      padding:14px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .hamburger{width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:#fff;display:grid;place-items:center;cursor:pointer}
    .hamburger span{display:block;width:18px;height:2px;background:#7c8aa3; position:relative}
    .hamburger span::before,.hamburger span::after{content:"";position:absolute;left:0;width:18px;height:2px;background:#7c8aa3}
    .hamburger span::before{top:-6px}.hamburger span::after{top:6px}
    .title{display:flex;flex-direction:column;line-height:1.05}
    .title h1{margin:0;font-size:22px}
    .title small{color:var(--muted)}
    .spacer{flex:1}
    .badge{border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa;padding:8px 12px;border-radius:14px;font-weight:900}
    .avatar{width:38px;height:38px;border-radius:50%;background:#e8edf3;border:1px solid #d3dae6}

    .layout{display:grid; grid-template-columns:260px 1fr; gap:18px; padding:18px;}
    nav{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); padding:14px;
      height: calc(100vh - 110px); position:sticky; top:92px; overflow:auto;
    }
    nav a{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      color:var(--muted); text-decoration:none; font-weight:800;
    }
    nav a.active{background:#e7f2ff;color:#1e5aaa;border:1px solid #cfe2ff}
    nav .group{margin-top:10px; padding-top:10px; border-top:1px dashed #e2e8f2}

    main{min-width:0}
    .quick{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px;}
    .qcard{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .qtitle{font-weight:900}
    .qdesc{color:var(--muted); font-size:12px; margin-top:4px}
    .qbtn{
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:10px 12px; cursor:pointer; font-weight:900; color:var(--text);
      white-space:nowrap;
    }
    .qbtn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; border-color:transparent}

    .grid-kpi{display:grid; grid-template-columns:repeat(6,minmax(140px,1fr)); gap:12px;}
    .kpi{
      background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:12px 14px; cursor:pointer;
    }
    .kpi .name{color:var(--muted); font-size:12px; font-weight:900; letter-spacing:.2px}
    .kpi .val{font-size:28px; font-weight:900; color:var(--brand); margin-top:6px}

    .grid-2{display:grid; grid-template-columns:1.6fr 1fr; gap:14px; margin-top:14px;}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow);
      padding:14px; min-width:0;
    }
    .card h2{margin:0 0 10px;font-size:16px}
    .muted{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:10px 12px; cursor:pointer; font-weight:900; color:var(--text);
    }
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; border-color:transparent}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .item{background:#f7f9fc;border:1px solid #e6ecf6;border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid}
    .pill.danger{background:#fff0f0;border-color:#ffd2d2;color:#b13b3b}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:14px}
    .footer{margin-top:12px;color:#8a9ab4;font-size:12px}

    @media (max-width:1200px){ .grid-kpi{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      nav{height:auto;position:relative;top:auto}
      .quick{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <button class="hamburger" aria-label="เมนู"><span></span></button>
    <div class="title">
      <h1>ระบบติดตามผลการตรวจสอบการเงิน (FA) แบบเรียลไทม์</h1>
      <small>ติดตามสถานะ • งวด/ปีงบประมาณ • ความก้าวหน้า • ประเด็นปัญหา • เรียลไทม์</small>
    </div>
    <div class="spacer"></div>
    <div class="badge" id="roleBadge">สถานะ: ยังไม่ได้เข้าสู่ระบบ</div>
    <div class="avatar" aria-hidden="true"></div>
  </header>

  <div class="layout">
    <nav>
      <a class="active" href="index.html">หน้าแรก</a>

      <!-- ✅ NEW: Auth -->
      <a href="register.html">ลงทะเบียนผู้ใช้</a>
      <a href="login.html">เข้าสู่ระบบ</a>

      <div class="group">
        <a href="upload.html">อัปโหลดไฟล์</a>
        <a href="manual-entry.html">บันทึกข้อมูลด้วยตนเอง</a>
        <a href="manual-review.html">ตรวจทาน &amp; ส่งข้อมูล</a>
        <a href="cashboard.html">แคชบอร์ด (FA 2.1.7–2.1.20)</a>
        <a href="cashboard-fin-oap.html">แคชบอร์ดภาพรวมงบการเงิน อปท.</a>
      </div>

      <div class="group">
        <a href="vault-upload.html">คลังข้อมูล • รายการอัปโหลด</a>
        <a href="vault-overview.html">คลังข้อมูล • ภาพรวมข้อมูลบันทึกเอง</a>
        <a href="vault-search.html">คลังข้อมูล • ค้นหาขั้นสูง</a>
        <a href="vault-results.html">คลังข้อมูล • ตารางผลลัพธ์</a>
      </div>

      <div class="group">
        <a href="admin-users.html">ผู้ดูแลระบบ • ผู้ใช้ &amp; สิทธิ์</a>
        <a href="admin-settings.html">ผู้ดูแลระบบ • ตั้งค่าระบบ</a>
        <a href="admin-auditlog.html">ผู้ดูแลระบบ • บันทึกการแก้ไข (Audit Log)</a>
        <a href="reports.html">รายงาน / ส่งออกไฟล์</a>
      </div>
    </nav>

    <main>
      <!-- ✅ NEW: Quick auth cards -->
      <section class="quick">
        <div class="qcard">
          <div>
            <div class="qtitle">ลงทะเบียนผู้ใช้</div>
            <div class="qdesc">สร้างบัญชีผู้ใช้งาน เพื่อใช้งานระบบบันทึก/ติดตาม/แคชบอร์ด</div>
          </div>
          <button class="qbtn" onclick="location.href='register.html'">ไปลงทะเบียน</button>
        </div>

        <div class="qcard">
          <div>
            <div class="qtitle">เข้าสู่ระบบ</div>
            <div class="qdesc">เข้าสู่ระบบเพื่อบันทึกข้อมูลและใช้งานเมนูผู้ดูแล (ตามสิทธิ์)</div>
          </div>
          <button class="qbtn primary" onclick="location.href='login.html'">ไปหน้า Login</button>
        </div>
      </section>

      <section class="quick">
        <div class="qcard">
          <div>
            <div class="qtitle">แคชบอร์ด (สถานะการตรวจสอบ FA)</div>
            <div class="qdesc">ภาพรวมข้อ 2.1.7–2.1.20 • เลือกดูปี/ไตรมาส/เดือน/วัน/หน่วย/พื้นที่</div>
          </div>
          <button class="qbtn primary" onclick="location.href='cashboard.html'">เปิดแคชบอร์ด</button>
        </div>

        <div class="qcard">
          <div>
            <div class="qtitle">แคชบอร์ดภาพรวมงบการเงิน อปท.</div>
            <div class="qdesc">สรุปงบการเงิน อปท. (ภาพรวม) • พร้อม drill-down ตามพื้นที่/ประเภทหน่วย</div>
          </div>
          <button class="qbtn" onclick="location.href='cashboard-fin-oap.html'">ดูภาพรวมงบฯ อปท.</button>
        </div>
      </section>

      <section class="grid-kpi" id="kpiGrid"></section>

      <section class="grid-2">
        <div class="card">
          <h2>สถานะการตรวจสอบ FA (ข้อ 2.1.7)</h2>
          <div class="muted">สรุปภาพรวม (เวอร์ชันทดสอบ) — คลิกการ์ด KPI เพื่อเจาะลึกไปที่แคชบอร์ด</div>
          <div class="actions">
            <button class="btn primary" onclick="location.href='cashboard.html'">เปิดแคชบอร์ด FA</button>
            <button class="btn" onclick="location.href='cashboard-fin-oap.html'">เปิดแคชบอร์ดงบฯ อปท.</button>
            <button class="btn" onclick="location.href='manual-entry.html'">บันทึกข้อมูลใหม่</button>
            <button class="btn" onclick="location.href='upload.html'">อัปโหลดไฟล์</button>
          </div>
          <div class="footer" id="lastUpdate"></div>
        </div>

        <div class="card">
          <h2>รายการที่ต้องติดตาม (ปัญหา / ข้อเสนอแนะ)</h2>
          <div class="muted">รายการ “ข้อยกเว้น” ที่ควรเร่งจัดการ (เวอร์ชันทดสอบ)</div>
          <div class="list" id="actionList"></div>
        </div>
      </section>

      <section class="grid-3">
        <div class="card">
          <h2>แนวโน้มตามปีงบประมาณ</h2>
          <div class="muted">กราฟตัวอย่าง (wireframe)</div>
          <canvas id="trendFY" height="120"></canvas>
        </div>
        <div class="card">
          <h2>แนวโน้มรายเดือน</h2>
          <div class="muted">กราฟตัวอย่าง (wireframe)</div>
          <canvas id="trendM" height="120"></canvas>
        </div>
        <div class="card">
          <h2>แนวโน้มรายวัน</h2>
          <div class="muted">กราฟตัวอย่าง (wireframe)</div>
          <canvas id="trendD" height="120"></canvas>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Auth (Prototype): localStorage =====
    const SESSION_KEY = "fa_session_v1";
    function updateHeader(){
      const badge = document.getElementById("roleBadge");
      const s = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if(!s){ badge.textContent = "สถานะ: ยังไม่ได้เข้าสู่ระบบ"; return; }
      badge.textContent = "ผู้ใช้: " + (s.fullname || s.username) + " • บทบาท: " + (s.role || "USER");
    }
    updateHeader();

    // ===== Dashboard data demo =====
    const KEY = "fa_records_v1";
    function seedIfEmpty(){
      const cur = JSON.parse(localStorage.getItem(KEY) || "[]");
      if(cur.length) return;
      const now = Date.now();
      const sample = [];
      for(let i=1;i<=88;i++){
        const statusPick = ["อยู่ระหว่างตรวจสอบ","ออกรายงานแล้ว","ยังไม่ตรวจ","เงินขาดบัญชี","ไม่ทราบสถานะ"];
        const st = statusPick[Math.floor(Math.random()*statusPick.length)];
        sample.push({
          id: "TH-XX-" + String(i).padStart(4,"0") + "-001",
          fy: 2568,
          quarter: ["ไตรมาส 1","ไตรมาส 2","ไตรมาส 3","ไตรมาส 4"][Math.floor(Math.random()*4)],
          province: ["ศรีสะเกษ","อุบลราชธานี","ขอนแก่น","เชียงใหม่"][Math.floor(Math.random()*4)],
          entityType: ["อบจ.","เทศบาล","อบต."][Math.floor(Math.random()*3)],
          status_217: st,
          cashShortage_217: st==="เงินขาดบัญชี",
          adjustments_216: ["ไม่มี/น้อยมาก","5-9 รายการ","10-19 รายการ","20-29 รายการ","30-39 รายการ","40-50 รายการ","มากกว่า 51 รายการ"][Math.floor(Math.random()*7)],
          created_at: now - Math.floor(Math.random()*280)*86400000,
          updated_at: now - Math.floor(Math.random()*30)*86400000,
          problems_219: ["คน","งาน","ระยะเวลา","เครื่องมือ","งบประมาณ","หน่วยรับตรวจ","ไม่มีปัญหา","ไม่ทราบ"][Math.floor(Math.random()*8)],
          rec_220: "แนวทางปรับปรุงเพื่อแก้สาเหตุราก (Root cause) และเพิ่มความทันเวลา"
        });
      }
      localStorage.setItem(KEY, JSON.stringify(sample));
    }
    function computeKPI(records){
      const k = {"อยู่ระหว่างตรวจสอบ":0,"ออกรายงานแล้ว":0,"ยังไม่ตรวจ":0,"เงินขาดบัญชี":0,"ปรับปรุงบัญชีมาก":0,"ไม่ทราบสถานะ":0};
      for(const r of records){
        if(r.status_217==="อยู่ระหว่างตรวจสอบ") k["อยู่ระหว่างตรวจสอบ"]++;
        else if(r.status_217==="ออกรายงานแล้ว") k["ออกรายงานแล้ว"]++;
        else if(r.status_217==="ยังไม่ตรวจ") k["ยังไม่ตรวจ"]++;
        else if(r.status_217==="เงินขาดบัญชี") k["เงินขาดบัญชี"]++;
        else k["ไม่ทราบสถานะ"]++;
        if(r.adjustments_216==="มากกว่า 51 รายการ" || r.adjustments_216==="40-50 รายการ") k["ปรับปรุงบัญชีมาก"]++;
      }
      return k;
    }
    function renderKPIs(k){
      const order=["อยู่ระหว่างตรวจสอบ","ออกรายงานแล้ว","ยังไม่ตรวจ","เงินขาดบัญชี","ปรับปรุงบัญชีมาก","ไม่ทราบสถานะ"];
      const grid=document.getElementById("kpiGrid");
      grid.innerHTML=order.map(name=>`
        <div class="kpi" onclick="location.href='cashboard.html?focus='+encodeURIComponent(name)">
          <div class="name">${name}</div>
          <div class="val">${k[name]??0}</div>
        </div>`).join("");
    }
    function renderActionList(records){
      const list=document.getElementById("actionList");
      const exceptions=records.filter(r=>r.cashShortage_217 || r.adjustments_216==="มากกว่า 51 รายการ" || r.status_217==="ยังไม่ตรวจ")
        .sort((a,b)=>b.updated_at-a.updated_at).slice(0,5);
      list.innerHTML=exceptions.map(r=>`
        <div class="item">
          <div>
            <div style="font-weight:900">${r.id}</div>
            <div class="muted" style="font-size:12px">ปีงบฯ ${r.fy} • ${r.quarter} • ${r.province} • ${r.entityType}</div>
          </div>
          <div class="pill danger">${r.status_217}</div>
        </div>`).join("") || `<div class="muted">ไม่พบรายการที่ต้องติดตาม</div>`;
    }
    function miniLine(canvasId){
      const c=document.getElementById(canvasId), ctx=c.getContext("2d");
      const w=c.width=c.parentElement.clientWidth-28; c.height=120;
      ctx.clearRect(0,0,w,120); ctx.strokeStyle="#1e5aaa"; ctx.lineWidth=2.5;
      const pts=[...Array(8)].map((_,i)=>({x:i*(w/7),y:20+Math.random()*80}));
      ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); pts.forEach(p=>ctx.lineTo(p.x,p.y)); ctx.stroke();
      ctx.fillStyle="#1e5aaa"; pts.forEach(p=>{ctx.beginPath(); ctx.arc(p.x,p.y,3.5,0,Math.PI*2); ctx.fill();});
    }

    seedIfEmpty();
    const records = JSON.parse(localStorage.getItem(KEY) || "[]");
    renderKPIs(computeKPI(records));
    renderActionList(records);
    miniLine("trendFY"); miniLine("trendM"); miniLine("trendD");
    const last=new Date(Math.max(...records.map(r=>r.updated_at)));
    document.getElementById("lastUpdate").textContent =
      "อัปเดตล่าสุด: " + last.toLocaleString() + " • จำนวนข้อมูล: " + records.length + " (โหมดทดสอบ: ข้อมูลเก็บในเครื่อง)";
  </script>
</body>
</html>
