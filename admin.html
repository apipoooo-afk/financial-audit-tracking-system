<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (FA) ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</title>

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --line:#dde5f2; --text:#24364c; --muted:#6a7f9a;
      --brand:#1e5aaa; --brand2:#2f7de1;
      --shadow:0 10px 28px rgba(20,40,80,.08);
      --r:18px;
      --ok:#1f7a3b; --bad:#b13b3b; --warn:#8a5a00; --info:#0b5aa6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans";background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
      padding:14px 18px;display:flex;align-items:center;gap:12px
    }
    .title{display:flex;flex-direction:column;line-height:1.05}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .spacer{flex:1}
    .badge{border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa;padding:8px 12px;border-radius:14px;font-weight:900}

    .wrap{max-width:1200px;margin:18px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{
      grid-column:span 12;
      background:var(--card);border:1px solid var(--line);border-radius:var(--r);
      box-shadow:var(--shadow);padding:14px;min-width:0
    }
    @media(min-width:900px){
      .col6{grid-column:span 6}
      .col4{grid-column:span 4}
      .col8{grid-column:span 8}
    }

    h2{margin:0 0 8px;font-size:16px}
    h3{margin:0 0 6px;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}

    .btn{
      width:100%;
      border:1px solid var(--line); background:#fff; border-radius:14px;
      padding:12px 12px; cursor:pointer; font-weight:900; color:var(--text);
      text-align:left
    }
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
    .btn.danger{background:#fff0f0;border-color:#ffd2d2;color:var(--bad)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:190px}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #cfe2ff;background:#eef6ff;color:#1e5aaa}
    .pill.ok{border-color:#c8f2d6;background:#effaf3;color:var(--ok)}
    .pill.warn{border-color:#ffe7b8;background:#fff7e6;color:var(--warn)}
    .pill.bad{border-color:#ffd2d2;background:#fff0f0;color:var(--bad)}
    .pill.info{border-color:#cfe2ff;background:#eef6ff;color:var(--info)}
    .tiny{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .box{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .kpi .box b{font-size:18px}

    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:14px;font-weight:900}
    .okBox{border:1px solid #c8f2d6;background:#effaf3;color:var(--ok)}
    .badBox{border:1px solid #ffd2d2;background:#fff0f0;color:var(--bad)}
    .warnBox{border:1px solid #ffe7b8;background:#fff7e6;color:var(--warn)}
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h1>
    <small>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö ‚Ä¢ ‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå Upload ‚Ä¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Manual ‚Ä¢ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‚Ä¢ Export/Import ‚Ä¢ ‡πÑ‡∏õ Cashboard</small>
  </div>
  <div class="spacer"></div>
  <div class="badge" id="userBadge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‚Ä¶</div>
</header>

<div class="wrap">
  <div class="grid">

    <div class="card col8">
      <h2>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin KPI)</h2>
      <div class="muted">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ (localStorage) ‚Ä¢ ‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÅ‡∏•‡∏∞ ‚ÄúAudit Trail‚Äù</div>

      <div class="hr"></div>
      <div class="kpi">
        <div class="box">
          <div class="tiny">Manual Records</div>
          <b id="kManual">0</b>
        </div>
        <div class="box">
          <div class="tiny">Submitted</div>
          <b id="kSubmitted">0</b>
        </div>
        <div class="box">
          <div class="tiny">Locked (>=356 ‡∏ß‡∏±‡∏ô)</div>
          <b id="kLocked">0</b>
        </div>
        <div class="box">
          <div class="tiny">Upload Files</div>
          <b id="kFiles">0</b>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn primary" id="goCashboard">‡πÑ‡∏õ Cashboard (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° 2.1.7‚Äì2.1.20)</button>
        <button class="btn" id="goDataHub">‡πÑ‡∏õ Data Hub</button>
        <button class="btn" id="goHome">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      </div>

      <div class="msg okBox" id="ok"></div>
      <div class="msg warnBox" id="warn"></div>
      <div class="msg badBox" id="bad"></div>
    </div>

    <div class="card col4">
      <h2>‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î‡πÄ‡∏°‡∏ô‡∏π Admin</h2>
      <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>

      <div class="hr"></div>

      <button class="btn" id="goUploads">
        üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå Upload
        <div class="tiny">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç tag/‡∏•‡∏ö/Export</div>
      </button>

      <div style="height:10px"></div>

      <button class="btn" id="goManualTable">
        üßæ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Manual Data (Excel-like)
        <div class="tiny">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö/Export ‚Ä¢ ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏•‡πá‡∏≠‡∏Å 356 ‡∏ß‡∏±‡∏ô</div>
      </button>

      <div style="height:10px"></div>

      <button class="btn" id="goManualSearch">
        üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Manual Data (2.2 ‚Üí 2.3)
        <div class="tiny">‡∏õ‡∏µ‡∏á‡∏ö‡∏Ø / ‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà / keyword</div>
      </button>

      <div class="hr"></div>

      <button class="btn" id="goManualEntry">
        ‚úçÔ∏è ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Manual (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
        <div class="tiny">‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
      </button>

      <div style="height:10px"></div>

      <button class="btn danger" id="btnLogout">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Logout)
        <div class="tiny">‡∏•‡∏ö session ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>
      </button>
    </div>

    <div class="card col6">
      <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup & Restore)</h2>
      <div class="muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÉ‡∏ä‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
      <div class="hr"></div>

      <div class="row">
        <button class="btn primary" id="btnExportAll">Export ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (JSON)</button>
        <button class="btn" id="btnImportAll">Import ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (JSON)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="hr"></div>
      <div class="muted">
        Key Manual: <span class="pill info mono">fa_manual_records_v1</span> ‚Ä¢
        Key Upload: <span class="pill info mono">fa_upload_files_v1</span>
      </div>
    </div>

    <div class="card col6">
      <h2>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Quality Quick Check)</h2>
      <div class="muted">‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß: ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ß‡πà‡∏≤‡∏á/‡∏õ‡∏µ‡∏á‡∏ö‡∏Ø‡∏ú‡∏¥‡∏î‡∏ä‡πà‡∏ß‡∏á/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ã‡πâ‡∏≥</div>
      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnDQ">‡∏£‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn" id="btnFixSuggest">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>

      <div class="hr"></div>
      <div class="muted" id="dqOut">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô</div>
    </div>

  </div>
</div>

<script>
/* =========================
   Guard: login + ADMIN
   ========================= */
const SESSION_KEY = "fa_session_v1";
const session = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
if(!session){ location.href="login.html"; }
const role = (session.role || "USER").toUpperCase();
if(role !== "ADMIN"){
  alert("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (ADMIN) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
  location.href="index.html";
}
document.getElementById("userBadge").textContent =
  "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + (session.fullname || session.username) + " ‚Ä¢ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: " + role;

/* =========================
   Keys
   ========================= */
const MANUAL_KEY = "fa_manual_records_v1";
const UPLOAD_KEY = "fa_upload_files_v1";

/* =========================
   Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
function show(box, text){
  const el = $(box);
  el.textContent = text;
  el.style.display="block";
  setTimeout(()=>el.style.display="none", 2500);
}
function getJSON(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }
function isLocked(created_at){
  if(!created_at) return false;
  const days = (Date.now() - created_at)/86400000;
  return days >= 356;
}
function downloadText(filename, text, mime="application/json"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* =========================
   KPI
   ========================= */
function refreshKPI(){
  const manual = getJSON(MANUAL_KEY).filter(x=>!x.deleted);
  const uploads = getJSON(UPLOAD_KEY).filter(x=>!x.deleted);

  const submitted = manual.filter(x=>!!x.submitted).length;
  const locked = manual.filter(x=>isLocked(x.created_at)).length;

  $("kManual").textContent = manual.length;
  $("kSubmitted").textContent = submitted;
  $("kLocked").textContent = locked;
  $("kFiles").textContent = uploads.length;
}
refreshKPI();

/* =========================
   Nav
   ========================= */
$("goCashboard").addEventListener("click", ()=>location.href="cashboard.html");
$("goDataHub").addEventListener("click", ()=>location.href="data-hub.html");
$("goHome").addEventListener("click", ()=>location.href="index.html");

$("goUploads").addEventListener("click", ()=>location.href="admin-upload-files.html");
$("goManualTable").addEventListener("click", ()=>location.href="admin-manual-table.html");
$("goManualSearch").addEventListener("click", ()=>location.href="admin-manual-search.html");
$("goManualEntry").addEventListener("click", ()=>location.href="manual-entry.html");

/* =========================
   Logout
   ========================= */
$("btnLogout").addEventListener("click", ()=>{
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) return;
  localStorage.removeItem(SESSION_KEY);
  location.href="login.html";
});

/* =========================
   Export/Import All
   ========================= */
$("btnExportAll").addEventListener("click", ()=>{
  const payload = {
    exported_at: Date.now(),
    exported_by: (session.fullname || session.username),
    manual_records: getJSON(MANUAL_KEY),
    upload_files: getJSON(UPLOAD_KEY)
  };
  downloadText(`fa_admin_backup_${Date.now()}.json`, JSON.stringify(payload,null,2), "application/json");
  show("ok","Export ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
});

$("btnImportAll").addEventListener("click", ()=>$("importFile").click());

$("importFile").addEventListener("change", async ()=>{
  const f = $("importFile").files?.[0];
  if(!f) return;
  try{
    const payload = JSON.parse(await f.text());
    const inManual = Array.isArray(payload.manual_records) ? payload.manual_records : [];
    const inUpload = Array.isArray(payload.upload_files) ? payload.upload_files : [];

    const curManual = getJSON(MANUAL_KEY);
    const curUpload = getJSON(UPLOAD_KEY);

    const mIds = new Set(curManual.map(x=>x.id));
    const uIds = new Set(curUpload.map(x=>x.id));

    const addManual = inManual.filter(x=>x && x.id && !mIds.has(x.id));
    const addUpload = inUpload.filter(x=>x && x.id && !uIds.has(x.id));

    localStorage.setItem(MANUAL_KEY, JSON.stringify(curManual.concat(addManual)));
    localStorage.setItem(UPLOAD_KEY, JSON.stringify(curUpload.concat(addUpload)));

    show("ok", `Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Manual ${addManual.length} ‚Ä¢ Upload ${addUpload.length}`);
    $("importFile").value="";
    refreshKPI();
  }catch(e){
    show("bad","Import ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  }
});

/* =========================
   Data Quality quick checks
   ========================= */
let lastDQ = null;

$("btnDQ").addEventListener("click", ()=>{
  const manual = getJSON(MANUAL_KEY).filter(x=>!x.deleted);
  const issues = [];

  // required-ish fields for core
  manual.forEach((r,idx)=>{
    const id = r.id || `row#${idx+1}`;
    const fy = Number(r.period?.fiscalYear||0);
    if(!(fy>=2560 && fy<=2580)) issues.push({id, type:"FY_RANGE", msg:`‡∏õ‡∏µ‡∏á‡∏ö‡∏Ø‡∏ú‡∏¥‡∏î‡∏ä‡πà‡∏ß‡∏á: ${fy}`});
    if(!r.entity?.name) issues.push({id, type:"ENTITY_EMPTY", msg:`‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏á`});
    if(!r.entity?.province) issues.push({id, type:"PROVINCE_EMPTY", msg:`‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á`});
    if(!r.s217) issues.push({id, type:"FA_STATUS_EMPTY", msg:`2.1.7 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ FA ‡∏ß‡πà‡∏≤‡∏á`});
  });

  // possible duplicates (same entity+fy+period)
  const seen = new Map();
  manual.forEach(r=>{
    const k = [r.entity?.type,r.entity?.name,r.entity?.province,r.period?.fiscalYear,r.period?.periodType,r.period?.periodValue].join("|");
    if(!seen.has(k)) seen.set(k, []);
    seen.get(k).push(r.id);
  });
  for(const [k,ids] of seen.entries()){
    if(ids.length>1) issues.push({id: ids.join(","), type:"DUP_KEY", msg:`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ key=${k} (‡∏û‡∏ö ${ids.length})`});
  }

  lastDQ = issues;
  $("dqOut").innerHTML = issues.length
    ? `‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ${issues.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="pill warn">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à</span><div class="tiny">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ${issues.slice(0,5).map(x=>x.type).join(", ")}${issues.length>5?" ...":""}</div>`
    : `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô <span class="pill ok">‡∏ú‡πà‡∏≤‡∏ô</span>`;
  show("ok","‡∏£‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
});

$("btnFixSuggest").addEventListener("click", ()=>{
  if(!lastDQ){ show("warn","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
  if(lastDQ.length===0){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô"); return; }

  const lines = lastDQ.slice(0,30).map((x,i)=>`${i+1}. [${x.type}] (${x.id}) ${x.msg}`).join("\n");
  alert("‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏™‡∏î‡∏á 30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å)\n\n" + lines + (lastDQ.length>30?`\n\n...‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏µ‡∏Å ${lastDQ.length-30} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`: ""));
});
</script>
</body>
</html>